{"version":3,"sources":["../../src/bootstrap/write-js-requires.js"],"names":["_","require","fs","store","emitter","writeAll","state","program","pages","matchPaths","values","components","forEach","p","push","componentChunkName","component","uniqBy","c","syncRequires","map","join","asyncRequires","writeAndMove","file","data","destination","directory","tmp","Date","now","writeFile","then","move","overwrite","Promise","all","JSON","stringify","debouncedWriteAll","debounce","getState","leading","startPageListener","on","module","exports"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst fs = require(`fs-extra`)\nimport { joinPath } from \"../utils/path\"\nconst { store, emitter } = require(`../redux`)\n\nconst writeAll = async state => {\n  let { program, pages, matchPaths } = state\n  pages = [...pages.values()]\n\n  let components = []\n  pages.forEach(p => {\n    components.push({\n      componentChunkName: p.componentChunkName,\n      component: p.component,\n    })\n  })\n\n  components = _.uniqBy(components, c => c.componentChunkName)\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `const { hot } = require(\"react-hot-loader/root\")\n\n// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": hot(preferDefault(require(\"${joinPath(\n          c.component\n        )}\")))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": () => import(\"${joinPath(\n          c.component\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  return await Promise.all([\n    // writeAndMove(`pages.json`, JSON.stringify(pagesData, null, 4)),\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(`match-paths.json`, JSON.stringify(matchPaths, null, 4)),\n  ])\n}\n\nconst debouncedWriteAll = _.debounce(() => writeAll(store.getState()), 500, {\n  leading: true,\n})\n\nconst startPageListener = () => {\n  emitter.on(`CREATE_PAGE`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, () => {\n    debouncedWriteAll()\n  })\n}\n\nmodule.exports = {\n  writeAll,\n  startPageListener,\n}\n"],"file":"write-js-requires.js"}